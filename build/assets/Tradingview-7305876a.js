import{d as n}from"./datafeed-a8c86d1b.js";import{u as d,__tla as p}from"./market-6d56493b.js";import{_ as b}from"./_plugin-vue_export-helper-8676f0c8.js";import"./_commonjsHelpers-87174ba5.js";import"./pinia-72e453fe.js";let h,_=Promise.all([(()=>{try{return p}catch{}})()]).then(async()=>{const c={binance:["1","3","5","15","30","60","120","240","360","480","720","D","W","M"],kucoin:["1","5","15","30","60","240","D","W","M"]},o=c[provider],l={binance:{"1m":"1","3m":"3","5m":"5","15m":"15","30m":"30","1h":"60","2h":"120","4h":"240","6h":"360","8h":"480","12h":"720","1d":"D",w:"W",m:"M"},kucoin:{"1m":"1","5m":"5","15m":"15","30m":"30","1h":"60","4h":"240","1d":"D",w:"W",m:"M"}},a=l[provider],m={name:"KLineWidget",setup(){return{marketStore:d()}},data(){return{interval:"1m",ws:null,since:null,widget:null,duration:864e5,now:Date.now(),lastprice:[],pair:this.$route.params.symbol+"/"+this.$route.params.currency,datafeed:new n.DataFeed({getBars:t=>this.getBars(t),fetchResolveSymbol:()=>this.resolveSymbol(),fetchConfiguration:()=>new Promise(t=>{t({supported_resolutions:o})})})}},created(){},mounted(){this.initTradingView(),this.parentHeight=this.$parent.$el.offsetHeight},methods:{resolveSymbol(){return new Promise(t=>{var e=this.$route.params.symbol+"/"+this.$route.params.currency;this.marketStore.bestAsk,t({name:e,full_name:e,description:e,type:e,session:"24x7",pricescale:[1,1,100],exchange:gnl.sitename.toUpperCase(),listed_exchange:gnl.sitename.toUpperCase(),timezone:"Etc/UTC",format:"price",minmov:1,has_intraday:!0,supported_resolutions:o,volume_precision:2,data_status:"streaming"})})},async getBars(t){if(!t.firstDataRequest)return{bars:[],meta:{noData:!0}};if(t.resolution!==a[this.interval]){this.unsubscribeKLine();for(let s in a)a[s]===t.resolution&&(this.interval=s)}const e=await this.getKLine(this.$route.params.symbol+"/"+this.$route.params.currency);if(t.resolution===a[this.interval]&&t.firstDataRequest&&e&&e.length&&this.subscribeKLine(this.$route.params.symbol+"/"+this.$route.params.currency),!e||!e.length)return{bars:[],meta:{noData:!0}};const i=[];for(let s=0;s<e.length;s++){const r=e[s];i.push({time:r[0],open:r[1],high:r[2],low:r[3],close:r[4],volume:r[5]})}return i.sort((s,r)=>s.time>r.time?1:-1),{bars:i,meta:{noData:!i.length}}},getRandomInt(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t))+t},getKLine(t){switch(a[this.interval]){case"1":this.duration=864e5;break;case"3":this.duration=2592e5;break;case"5":this.duration=432e6;break;case"15":this.duration=1296e6;break;case"30":this.duration=2592e6;break;case"60":this.duration=5184e6;break;case"120":this.duration=10368e6;break;case"240":this.duration=20736e6;break;case"320":this.duration=31104e6;break;case"480":this.duration=41472e6;break;case"720":this.duration=62208e6;break;case"D":this.duration=165888e6;break;case"W":this.duration=1161216e6;break;case"M":this.duration=497664e7;break}switch(provider){case"binance":this.since=this.now-this.duration/3;break;case"kucoin":this.since=this.now-this.duration;break;default:this.since=this.now-this.duration;break}try{return this.marketStore.exchange.fetchOHLCV(t,this.interval,this.since)}catch(e){if(console.log(e.constructor.name,e.message),e.constructor.name==419)return this.marketStore.exchange.fetchOHLCV(t,this.interval,this.since)}},handleTick(t){const e=document.getElementById("favicon");this.datafeed.updateKLine({time:t[0],open:t[1],high:t[2],low:t[3],close:t[4],volume:t[5]}),!this.lastprice[this.$route.params.symbol+"/"+this.$route.params.currency]||t[4]>this.lastprice[this.$route.params.symbol+"/"+this.$route.params.currency]?(document.title=t[4]+" | "+this.$route.params.symbol+"/"+this.$route.params.currency,e.href="/assets/up.png"):t[4]<this.lastprice[this.$route.params.symbol+"/"+this.$route.params.currency]?(document.title=t[4]+" | "+this.$route.params.symbol+"/"+this.$route.params.currency,e.href="/assets/down.png"):e.href="/assets/neutral.png",this.lastprice[this.$route.params.symbol+"/"+this.$route.params.currency]=t[4]},async subscribeKLine(){let t=[];for(;window.location.href.indexOf(this.$route.params.symbol+"/"+this.$route.params.currency)>-1;)try{t[this.$route.params.symbol+"/"+this.$route.params.currency]=await this.marketStore.exchange.watchOHLCV(this.$route.params.symbol+"/"+this.$route.params.currency,this.interval),this.handleTick(t[this.$route.params.symbol+"/"+this.$route.params.currency][t[this.$route.params.symbol+"/"+this.$route.params.currency].length-1])}catch{break}},async unsubscribeKLine(){const t=this.marketStore.exchange.clients[Object.keys(this.marketStore.exchange.clients)[Object.keys(this.marketStore.exchange.clients).length-1]];for(var e in t.subscriptions){const i={id:this.getRandomInt(0,1e3).toString(),type:"unsubscribe",topic:e,privateChannel:!1,response:!0};t.send(i)}},initTradingView(){$("<div>",{id:"tv_chart_container",style:"height: 100%;"}).appendTo("#creatable");var t=this.$route.params.symbol+"/"+this.$route.params.currency;this.widget=new n.widget({fullscreen:!1,width:"100%",height:"100%",symbol:t,interval:a[this.interval],container_id:"tv_chart_container",datafeed:this.datafeed,library_path:"/charting_library/",locale:"en",theme:theme=="dark"?"Dark":"Light",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,allow_symbol_change:!1,charts_storage_api_version:"1.1",client_id:"chart",toolbar_bg:"#1F2937",disabled_features:["header_compare","study_dialog_search_control","symbol_search_hot_key","header_symbol_search","go_to_date","compare_symbol","timezone_menu","timeframes_toolbar"],enabled_features:["dont_show_boolean_study_arguments","use_localstorage_for_settings","save_chart_properties_to_local_storage","side_toolbar_in_fullscreen_mode","hide_last_na_study_output","constraint_dialogs_movement","hide_left_toolbar_by_default"]})},setSymbol(t){this.unsubscribeKLine(),this.symbol=t,this.widget.setSymbol(t,a[this.interval],()=>{console.log("------setSymbol---------",this.symbol)})}}};function u(t,e,i,s,r,y){return null}h=b(m,[["render",u]])});export{_ as __tla,h as default};
